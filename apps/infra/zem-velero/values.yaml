# B2 storage configuration
b2:
  secretName: velero-b2-credentials
  bucket: zem-backups-eu
  prefix: ""  # Override per-cluster, e.g., "cluster03"
  region: eu-central-003
  s3Url: https://s3.eu-central-003.backblazeb2.com

# Backup schedules
schedules:
  daily:
    enabled: true
    schedule: "0 2 * * *"
    ttl: 720h  # 30 days
    includedNamespaces: []  # Empty means all namespaces
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - velero
    defaultVolumesToFsBackup: true

velero:
  # Disable CRD upgrade job - ArgoCD manages CRDs via the chart
  # This avoids the kubectl image issue (bitnami deprecated, alternatives use different tag schemes)
  # See: https://github.com/vmware-tanzu/helm-charts/issues/698
  upgradeCRDs: false

  # Use fully qualified image names (required for CRI-O/Podman short name enforcement)
  image:
    repository: docker.io/velero/velero

  # Note: CSI plugin is integrated into Velero core since v1.14, no init container needed
  # See: https://github.com/vmware-tanzu/velero-plugin-for-csi (archived)
  initContainers:
    - name: velero-plugin-for-aws
      image: docker.io/velero/velero-plugin-for-aws:v1.11.0
      imagePullPolicy: IfNotPresent
      volumeMounts:
        - mountPath: /target
          name: plugins

  resources:
    requests:
      cpu: 500m
      memory: 128Mi
    limits:
      cpu: 1000m
      memory: 512Mi

  # Enable file-system backup via node-agent DaemonSet
  deployNodeAgent: true

  nodeAgent:
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

  configuration:
    # Default backup storage location - will be created via template
    backupStorageLocation: []
    volumeSnapshotLocation: []

    # Use kopia for file-system backups (better than restic)
    uploaderType: kopia

    # Default to file-system backups for all volumes
    defaultVolumesToFsBackup: true

  credentials:
    useSecret: true
    existingSecret: velero-b2-credentials

  # Metrics for Victoria Metrics
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false

  # ConfigMaps for Velero plugins
  # Use fully qualified image for restore helper (required for CRI-O short name enforcement)
  configMaps:
    fs-restore-action-config:
      labels:
        velero.io/plugin-config: ""
        velero.io/pod-volume-restore: RestoreItemAction
      data:
        image: docker.io/velero/velero-restore-helper:v1.15.1
